---
title: "NerdGraph tutorial: Data obfuscation for your logs"
tags:
  - APIs
  - NerdGraph
  - Examples
  - Logs
metaDescription: "Create, query, and manage obfuscation rules for your log data with NerdGraph, the New Relic GraphQL explorer."
---

You control what customer data is logged with our log management service, so be sure to follow your organization's security guidelines to mask, obfuscate, or prevent sending any sensitive data. Our log management service automatically masks number patterns that appear to be for items such as credit cards or Social Security numbers. For more information, see our [security documentation](/docs/logs/get-started/new-relics-log-management-security-privacy) for log management.

We also provide options for you to manage and sanitize parts of your customer data when it arrives at New Relic. This makes it easier and safer for you, rather than needing to track down sensitive data in all of your applications and try to fix them at the source.

You can use NerdGraph at [api.newrelic.com/graphiql](https://api.newrelic.com/graphiql) to create, query, and manage your data obfuscation rules for logs. NerdGraph is our GraphQL-format API explorer.

**Reviewer:** What about the ability to set up obfuscation rules in the UI? I saw a front end design doc in Atlassian. Is there an ETA for that? Will both the API and the UI options be released at the same time?

## Obfuscation and hashing [#definitions]

Obfuscation is when we entirely mask or remove data with no means for retrieval. For example, if a log line `Sent 123-45-6789` becomes `Sent XXX-XX-XXXX`, that's obfuscation.

Hashing is when a sensitive value is replaced with that value, sent through a one-way hashing algorithm. This allows lookup of related records if you have the original value and are able to hash it. For instance, if a log line `Sent 123-45-6789` is hashed to `Sent XYZAB`, the `XYZAB` is the calculated result of hashing `123-45-6789`.

* Field-level obfuscation or hashing applies to the entire attribute on an event.
* In-message obfuscation or hashing means the rules can target part of a message, such as the `Sent` message examples in this section.

## Parts of an obfuscation rule [#components]

The obfuscation rule is an enriched entity for you to apply different regexes to logs. It has three main components:

* **Filter:** NRQL query to filter the logs you want to obfuscate

* **Expressions:** The regex you want to apply; for example:

  ```
  name: email
  regex: [^@ \t\r\n]+@[^@ \t\r\n]+\.[^@ \t\r\n]+
  ```

* **Actions:** Which attribute to apply an expression and which obfuscation method to use

## Create obfuscation rule [#create-rule]

Before you can create an obfuscation rule, first create an obfuscation expression:

```
mutation{createObfuscationExpression( 
   		accountId:12345678, 
            expression: { 
            name: "SimpleNumericExpression", 
            description: "", 
            regex: "([0-9])" 
            })
            {id name description regex}}
```

You'll get a response like this example:

```
{
	"data": {
		"createObfuscationExpression": {
			"id": "161",
			"name": "SimpleNumericExpression",
			"description": null,
			"regex": "([0-9])"
		}
	}
}
```

Then, to create an obfuscation rule, follow this example format. Replace the following [fields](#obfuscation-fields) with your values.

* `accountId`
* `name`
* `description`
* `filter`
* `method`
* `expressionId`

```
mutation { createObfuscationRule(accountId: 12345678, rule: {
                  name: "Auth Service Obfuscation Rule",
                  description: "Hashes numbers from auth service logs",
                  filter: "serviceName='AuthService'"
                  enabled: true,
                  actions: [
                      {
                          attributes: ["message"]
                          method: HASH_SHA256,
                          expressionId: 166,
                      }
                  ]
              }) {
                  id,
                  name,
                  description,
                  filter,
                  createdBy,
                  updatedBy,
                  enabled,
                  actions {
                      id,
                      attributes,
                      method,
                      expression {
                          id,
                          name,
                          description,
                          regex,
                          createdBy,
                          updatedBy,
                      }
                  }
              }
            }
```

## Expression examples [#expression-examples]

Here are API examples to create, query, update, and delete an obfuscation expression.

<CollapserGroup>
  <Collapser
    id="create-expression"
    title="Create obfuscation expression"
  >

  This NerdGraph API request example creates a new obfuscation expression. Required [fields](#obfuscation-fields) include:

  * `description`
  * `name`
  * `regex`

  ```
  mutation{createObfuscationExpression( 
   			accountId:12345678, 
            expression: { 
            name: "SimpleNumericExpression", 
            description: "", 
            regex: "([0-9])" 
             })
            {id name description regex}}
  ```
  
  </Collapser>

  <Collapser
    id="query-expression"
    title="Query obfuscation expression"
  >
  This NerdGraph API request example retrieves all the obfuscation expressions for a given account.

  ```
  { account { obfuscationExpressions {id name } } }
  ```

  You can include any of the following [fields](#obfuscation-fields) in your query:

  * `createdAt`
  * `createdBy`
  * `description`
  * `id`
  * `name`
  * `regex`
  * `updatedAt`
  * `updatedBy`
  
  </Collapser>

  <Collapser
    id="update-expression"
    title="Update obfuscation expression"
  >
  This example updates an obfuscation expression for your log data.

  ```
  mutation{updateObfuscationExpression( 
            accountId:12345678, 
            expression: { 
            id:160,
            name: "ModifiedName",  
            }) 
            {id name description regex}}
  ```
  
  Include the following [fields](#obfuscation-fields) as needed in your update. The `id` is required. The others are optional, but at least one must be present:

  * `description`
  * `id` (required)
  * `name`
  * `regex`

  </Collapser>

  <Collapser
    id="delete-expression"
    title="Delete obfuscation expression"
  >
  This example deletes an obfuscation expression for your log data. The `accountId` and `id` [fields](#obfuscation-fields) are required.

  ```
  mutation{deleteObfuscationExpression( 
            accountId:12345678, 
            id:160) 
            {id name description createdBy updatedBy }}
  ```

  **Reviewer:** Are there any guidelines or cautions about what happens when you delete the rule? For example, if they were previously masking something their company requires, how long would it take before logs would start showing that data? Does the deletion take effect immediately?

  </Collapser>

</CollapserGroup>

## Rule examples [#rule-examples]

Here are API examples to create, query, update, and delete an obfuscation rule.

<CollapserGroup>
  <Collapser
    id="create-rule"
    title="Create obfuscation rule"
  >
  
  This NerdGraph API request example creates a new obfuscation rule. Required [fields](#obfuscation-fields) include:

  * `actions`
  * `description`
  * `enabled`
  * `filter`
  * `name`
  * `regex`

  For `CreateObfuscationActionInput`, required [fields](#obfuscation-fields) include:

  * `attributes`: An empty list applies the action to all the attributes.
  * `expressionId`
  * `method`

  ```
  mutation { createObfuscationRule(accountId: 12345678, rule: {
                  name: "Auth Service Obfuscation Rule",
                  description: "Hashes numbers from auth service logs",
                  filter: "serviceName='AuthService'"
                  enabled: true,
                  actions: [
                      {
                          attributes: ["message"]
                          method: HASH_SHA256,
                          expressionId: 166,
                      }
                  ]
              }) {
                  id,
                  name,
                  description,
                  filter,
                  createdBy,
                  updatedBy,
                  enabled,
                  actions {
                      id,
                      attributes,
                      method,
                      expression {
                          id,
                          name,
                          description,
                          regex,
                          createdBy,
                          updatedBy,
                      }
                  }
              }
            }
  ```

  </Collapser>

  <Collapser
    id="query-rule"
    title="Query obfuscation rule"
  >
  This example retrieves all the obfuscation rules for an account.

  ```
  {
              account { 
                  obfuscationRules { 
                      name, 
                      description, 
                      filter, 
                      createdBy, 
                      updatedBy, 
                      enabled, 
                      actions { 
                              id, 
                              attributes, 
                              method, 
                              expression { 
                                  id, 
                                  name, 
                                  description, 
                                  regex, 
                                  createdBy, 
                                  updatedBy 
                              } 
                      } 
                  } 
              } 
            }
  ```

  You can include any of the following [fields](#obfuscation-fields) in your query:

  * `actions`
  * `createdAt`
  * `createdBy`
  * `description`
  * `id`
  * `name`
  * `regex`
  * `updatedAt`
  * `updatedBy`

  </Collapser>

  <Collapser
    id="update-rule"
    title="Update obfuscation rule"
  >
  
  This example updates an obfuscation rule for your log data.

  ```
  mutation { 
                updateObfuscationRule(accountId: 12345678, rule: { 
                    id: 5 
                    name: Some Rule, 
                    description: Masks dates and hashes names from login service logs, 
                    filter: serviceName='loginService' 
                    enabled: true, 
                    actions: [ 
                        { 
                            attributes: [message] 
                            method: HASH_SHA256, 
                            expressionId: 1, 
                        }, 
                        {
                            attributes: [message] 
                            method: MASK, 
                            expressionId: 2, 
                        },
                        { 
                            attributes: [message] 
                            method: HASH_SHA256, 
                            expressionId: 3, 
                        } 
                    ] 
                }) { 
                    id, 
                    name, 
                    description, 
                    filter, 
                    createdBy, 
                    updatedBy, 
                    enabled, 
                    actions { 
                        id, 
                        attributes, 
                        method, 
                        expression { 
                            id, 
                            name, 
                            description, 
                            regex, 
                            createdBy, 
                            updatedBy, 
                        } 
                    } 
                } 
            }
  ```

  Include the following [fields](#obfuscation-fields) as needed in your update. The `id` is required. The others are optional, but at least one must be present:

  * `actions`
  * `description`
  * `enabled`
  * `filter`
  * `id` (required)
  * `name`

  </Collapser>

  <Collapser
    id="delete-rule"
    title="Delete obfuscation rule"
  >
  This example deletes an obfuscation rule for your log data. The `accountId` and `id` [fields](#obfuscation-fields) are required.

  ```
  mutation{deleteObfuscationRule( 
            accountId:12345678, 
            id:5) 
            {id name description createdBy updatedBy }}
  ```

  **Reviewer:** Are there any guidelines or cautions about what happens when you delete the rule? For example, if they were previously masking something their company requires, how long would it take before logs would start showing that data? Does the deletion take effect immediately?

  </Collapser>

</CollapserGroup>



## Obfuscation API fields [#obfuscation-fields]

Available fields for your obfuscation rules and expressions include:

<table>
  <thead>
  <tr>
    <th style={{width: "200px"}}>
      Field
    </th>
    <th>
      Definition
    </th>
  </tr>
  </thead>

  <tbody>
  <tr>
    <td>
      `accountId` 
    </td>
    <td>
      Your New Relic account ID
    </td>
  </tr>
  <tr>
    <td>
      `actions` 
    </td>
    <td>
      Obfuscation actions to take if a record passes the matching criteria. Actions are applied in the order specified in the list. If a list of actions already exists for a rule, the actions in the [updated rule](#update-rule) replaces it.
    </td>
  </tr>
  <tr>
    <td>
      `attributes` 
    </td>
    <td>
      Attribute names for `action`. An empty list applies the action to all the attributes
    </td>
  </tr>
  <tr>
    <td>
      `createdAt` 
    </td>
    <td>
      Date and time the expression or rule was created
    </td>
  </tr>
  <tr>
    <td>
      `createdBy` 
    </td>
    <td>
      The user who created the expression or rule
    </td>
  </tr>
  <tr>
    <td>
      `description`
    </td>
    <td>
      Description of the obfuscation expression or rule (string)
    </td>
  </tr>
  <tr>
    <td>
      `enabled`
    </td>
    <td>
      Whether to apply the rule to the incoming logs (Boolean)
    </td>
  </tr>
  <tr>
    <td>
      `expressionId`
    </td>
    <td>
      The ID generated for the obfuscation expression
    </td>
  </tr>
  <tr>
    <td>
      `filter`
    </td>
    <td>
      * Expression: The entity that you want to apply the obfuscation rule to, such as an app, host, service, etc.
      * Rule: The NRQL filter that determines whether to apply the obfuscation actions to the log record
    </td>
  </tr>
  <tr>
    <td>
      `id` 
    </td>
    <td>
      The obfuscation rule's ID
    </td>
  </tr>
  <tr>
    <td>
      `method`
    </td>
    <td>
      The obfuscation method used for the expression or rule; for example, `HASH_SHA256`
    </td>
  </tr>
  <tr>
    <td>
      `name`
    </td>
    <td>
      Name of the obfuscation expression or rule (string)
    </td>
  </tr>
  <tr>
    <td>
      `regex`
    </td>
    <td>
      Regular expression for this obfuscation expression (string, 0-9). Capture groups are obscured on matching.
    </td>
  </tr>
  <tr>
    <td>
      `updatedAt`
    </td>
    <td>
      Date and time the expression or rule was last updated
    </td>
  </tr>
  <tr>
    <td>
      `updatedBy`
    </td>
    <td>
      The user who last updated the expression or rule
    </td>
  </tr>
  </tbody>
</table>

## Anything else? [#more]

**Reviewer:** Anything else to say about this API? For example, the security doc says if they need to opt out of automatic obfuscation, they should contact New Relic Support. Will that still be true with this API?
