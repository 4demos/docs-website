---
title: Hash or mask sensitive data in your logs (obfuscation)
metaDescription: 'How to hash or mask sensitive data in logs you send to New Relic with our obfuscation UI.'
---

An obfuscation rule applies a set of obfuscation [actions](#actions) to a set of target logs specified via a user-defined NRQL filter (matching criteria). Each obfuscation action references an existing obfuscation [expression (a regex)](#expressions) and applies it to a set of log attributes, based on your preferred obfuscation method (`HASH` or `MASK`).

## How obfuscation works [#overview]

Imagine you have the following log record:

```
{
  "message": "The credit card number 4321-5678-9876-2345 belongs to user user@email.com (born on 01/02/2003) with SSN 123-12-1234",
  "creditCardNumber": "4321-5678-9876-2345",
  "ssn": "123-12-1234",
  "department": "sales",
  "serviceName": "loginService"
}
```

This log record contains several sensitive data. Ideally, you would like your log to end up looking like this:

```
{
  "message": "The credit card number 9aa9bc1528859aee1b1df75795f1ebd54beb2f0d26c8a1d4580a71a07189cdd5 belongs to user user@email.com (born on XXXXXXXXXX) with SSN 30e6897f76dc102e32ee1d781c43417d259e586eac15c963d75ab8b5187769da",
  "creditCardNumber": "9aa9bc1528859aee1b1df75795f1ebd54beb2f0d26c8a1d4580a71a07189cdd5",
  "ssn": "30e6897f76dc102e32ee1d781c43417d259e586eac15c963d75ab8b5187769da",
  "department": "sales",
  "serviceName": "loginService"
}
```

<CollapserGroup>
  <Collapser
    id="actions"
    title="Actions"
  >

  You decide you want to apply the following obfuscation actions to all the logs coming from that service:
  
  * `HASH` the credit card number present in the `message` and `creditCardNumber` attributes.
  * `MASK` the birth date present in the `message` attribute.
  * `HASH` the social security number present in the `message` and `ssn` attributes.
  
  </Collapser>

  <Collapser
    id="expressions"
    title="Expressions"
  >

  The first thing you need to do is to define some obfuscation expressions that allow you to capture this sensitive information:
  
  **Obfuscation expression 1: Credit card number.**
  
  We need to capture 4 groups of 4 digits separated by hyphens:
  
  ```
  {
    "name": "Credit Card Number",
    "regex": "(\d{4}-\d{4}-\d{4}-\d{4})"
  }
  ```
  
  **Obfuscation expression 2: Social security number.**
  
  We need to capture 3 groups of 3, 2 and 4 digits separated by hyphens:
  
  ```
  {
    "name": "Social Security Number",
    "regex": "(\d{3}-\d{2}-\d{4})"
  }
  ```
  
  **Obfuscation expression 3: Born date.**
  
  In this example, the born date is part of the login service. We define the portion to obfuscate based on the date information in the surrounding words `"(born on 01/02/2003)"`:
  
  {
    "name": "Born date (loginService specific)",
    "regex": "born on (.*)\)"
  }
  
  Each obfuscation expression associates a regex with some friendly name so that you can easily identify it later in the UI. Also, your obfuscation expressions may be reused in multiple contexts.

  The first thing you need to do is to define some obfuscation expressions that allow you to capture this sensitive information:

**Obfuscation expression 1: Credit card number.**

We need to capture 4 groups of 4 digits separated by hyphens:

```
{
  "name": "Credit Card Number",
  "regex": "(\d{4}-\d{4}-\d{4}-\d{4})"
}
```

**Obfuscation expression 2: Social security number.**

We need to capture 3 groups of 3, 2 and 4 digits separated by hyphens:

```
{
  "name": "Social Security Number",
  "regex": "(\d{3}-\d{2}-\d{4})"
}
```

**Obfuscation expression 3: Born date.**

In this example, the born date is part of the login service. We define the portion to obfuscate based on the date information in the surrounding words `"(born on 01/02/2003)"`:

{
  "name": "Born date (loginService specific)",
  "regex": "born on (.*)\)"
}

Each obfuscation expression associates a regex with some friendly name so that you can easily identify it later in the UI. Also, your obfuscation expressions may be reused in multiple contexts.

  </Collapser>
  <Collapser
    id="rules"
    title="Rules"
  >

  Now that we have defined how to capture our sensitive data, we need to specify which logs need to be obfuscated (the ones of the Login Service) and how (with the obfuscation actions we defined). To achieve this, we will define an obfuscation rule.

  ```
  {
    "name": "Obfuscate Login Service Logs",
    "filter": "serviceName = 'loginService' AND department = 'sales'",
    "actions": [
      {
        "attributes": ["message", "creditCardNumber"],
        "expression": {"name": "Credit Card Number"}
        "method": "HASH_SHA256"
      },
      {
        "attributes": ["message"],
        "expression": {"name": "Born date (loginService specific)"}
        "method": "MASK"
      },
      {
        "attributes": ["message", "ssn"],
        "expression": {"name": "Social Security Number"}
        "method": "HASH_SHA256"
      }
    ]
  }
  ```
  
  This rule contains three pieces:

  <table>
    <thead>
      <tr>
        <th style={{ width: "150px" }}>
          Rule components
        </th>
        <th>
          Description
        </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          Name
        </td>
        <td>
          This helps us easily identify what the rule does. For example, this rule defines how to obfuscate the different attributes of the logs coming from the Login Service.
        </td>
      </tr>
      <tr>
        <td>
          Filter
        </td>
        <td>
          The filter uses NRQL format to tell our system how identify the target logs coming from the Login Service. This example queries for logs where `serviceName = loginService` and `department = sales`. Logs coming from another service (for example, the Checkout Service) would not match this criteria, as they would have `serviceName = checkoutService`).

          We want to define this filter because different services may have been developed by different development teams, and each team may have used arbitrary names for their log attributes. For instance, if the Checkout Service uses `ccn` for their credit card number attribute, we would need to define different obfuscation actions for these logs.
        </td>
      </tr>
      <tr>
        <td>
          Actions
        </td>
        <td>
          Finally, this rule defines the set of obfuscation actions to apply to the logs matching the filter. Each action defines which previously created obfuscation expression to use to:

          1. Extract the sensitive information from each set of attributes.
          2. Execute the method (`HASH_SHA256` or `MASK`) to obfuscate it.
      </td>
    </tr>
    </tbody>
  </table>

  </Collapser>
</CollapserGroup>

## Checklist: steps to obfuscate logs [#checklist]

To create obfuscation expressions and rules in the Logs UI:

1. Create obfuscation expressions to identify how to extract sensitive data.
2. Study the shape of your logs. Define how you will capture each set of them using NRQL.
3. Define obfuscation rules that capture logs having data to be obfuscated, and define which obfuscation actions need to be applied to each of them.

To do this in New Relic One:

1. Go to **[one.newrelic.com](https://one.newrelic.com) > Logs** and from the left nav, select **Obfuscation**.

2. Click **Create regex**.

3. Enter a name for your new obfuscation rule, and enter a regular expression matching the sensitive data you want to mask or hash. Use [RE2 syntax](https://github.com/google/re2/wiki/Syntax). The following example shows a basic obfuscation expression that will match US social security numbers:

4. Return to the **Obfuscation** page, and click **Create obfuscation rule**.

  * **Obfuscation name**: The name of your obfuscation rule.
  * **Matching criteria (NRQL)**: The NRQL query that will determine the subset of your log data this obfuscation rule will be applied to. In the example below, the rule will be applied to any log that contains an attribute named `socialsecurity`.
  * **Attributes**: One or more log attributes containing the values you wish to obfuscate. Multiple attributes may be specified here (attributes must be comma-separated).
  * **Select regex**: Select the obfuscation expression that will be used to match the sensitive data you wish to obfuscate.
  * **Replace with**: Select the obfuscation method you want to apply to your logs. Hash will replace sensitive data with a SHA-256 hash value. Mask will replace all matching characters with `Xs`.

5. To define multiple actions, click **Add new action**. This option allows you to specify additional attributes to be obfuscated as well as the obfuscation method to be used. In the example below, the `socialsecuritynum` and `request` attributes will be masked, and any value found in the `ccnum` attribute will be hashed.

6. Click **Create rule** to create and activate your obfuscation rule.

## Use obfuscation API [#nerdgraph-api]

You can also create, query, update, and delete your obfuscation settings programmatically by using NerdGraph, our GraphQL-format API, at [api.newrelic.com/graphiql](https://api.newrelic.com/graphiql). For more information, see the [NerdGraph tutorial](/docs/apis/nerdgraph/examples/nerdgraph-log-data-obfuscation) to manage your obfuscation expressions and rules.
