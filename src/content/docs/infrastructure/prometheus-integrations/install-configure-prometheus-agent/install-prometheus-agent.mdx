---
title: Install and configure the Prometheus agent alongside the Kubernetes integration
tags:
  - Integrations
  - Prometheus integrations
  - Install and configure Prometheus agent
metaDescription: 'How to install, update, or uninstall your New Relic Prometheus agent alongside the Kubernetes integration.'
---

import infrastructurePrometheusIoDashboard from 'images/infrastructure_screenshot-crop_prometheus-io-dashboard.png'

import infrastructurePrometheusNrqlQuery from 'images/infrastructure_screenshot-crop_prometheus-nrql-query.png'

New Relic's Prometheus agent is a thin wrapper on top of Prometheus server to run it in agent mode. With this integration, you can create a YAML configuration file used by Prometheus that's ready to send metrics to New Relic.

Learn more about the solution from [its repository](https://github.com/newrelic/newrelic-prometheus-configurator).

## Install the Prometheus agent alongside the Kubernetes integration [#kubernetes-install]

You can install our [Kubernetes integration](/docs/kubernetes-pixie/kubernetes-integration/get-started/introduction-kubernetes-integration) to get a full observability of your Kubernetes clusters, which includes the Prometheus agent.

1. Install our Kubernetes integration. See how to install it [here](/docs/kubernetes-pixie/kubernetes-integration/installation/kubernetes-integration-install-configure).

<Callout variant="tip">
  Alternatively, we also offer fully manual instructions for [deploying our integration using Helm](/docs/kubernetes-pixie/kubernetes-integration/installation/install-kubernetes-integration-using-helm).
</Callout>

2. To ensure the integration has been configured correctly, go to **[one.newrelic.com](https://one.newrelic.com) > All capabilities > Query builder**, and run this NRQL query to see if data has been reported:

  ```sql
  FROM Metric SELECT count(*) WHERE collector.name = 'prometheus-agent' AND cluster_name = 'YOUR_CLUSTER_NAME' since 1 hour ago
  ```

<Callout variant="tip">
  If you don't see your data right away, wait for a few seconds. Data may take some time to make it to New Relic.
</Callout>

## Install only the Prometheus agent [#prometheus-install]

If you don't need the Kubernetes integration, you can install the Prometheus agent by its own.

1. Install the [Prometheus Agent](https://github.com/newrelic/newrelic-prometheus-configurator#readme) by running:
  ```shell
  helm repo add newrelic-prometheus https://newrelic.github.io/newrelic-prometheus-configurator
  helm upgrade --install newrelic newrelic-prometheus/newrelic-prometheus-agent -f YOUR_CUSTOM_VALUES.yaml
  ```

2. To ensure the integration has been configured correctly, go to **[one.newrelic.com](https://one.newrelic.com) > All capabilities > Query builder**, and run this NRQL query to see if data has been reported:

  ```sql
  FROM Metric SELECT count(*) WHERE collector.name = 'prometheus-agent' since 1 hour ago
  ```

## Define which endpoints to scrape [#endpoints-scrape]

By default, the New Relic Prometheus agent uses two annotations to discover targets: `newrelic.io/scrape: "true"` and `prometheus.io/scrape: "true"`. 

All the targets in the cluster that are annotated with `newrelic.io/scrape: "true"` are discovered and scraped. 
Depending on the configuration the targets annotated with `prometheus.io/scrape: "true"` will be scraped or not.

### Scrape metrics only from Prometheus integrations

This is the default behavior. Prometheus Agent is configured to scrape metrics from the most popular integrations in Kubernetes, check the list of integrations [here](/docs/infrastructure/prometheus-integrations/integrations-list/integrations-list-intro) containing a set of dashboards and alerts to start monitoring out of the box.

### Scrape metrics from all the targets 

All the targets annotated with `prometheus.io/scrape: "true"`will be scraped withing the cluster.
Depending on the installation method you will need to:

- (Guided Install) Unselect the option "Scrape only metrics from Prometheus integrations"

<img width="635" alt="image" style="border: 1px solid black" src="https://user-images.githubusercontent.com/82898004/203292560-e24d1c6e-6f32-431d-92a5-7cd2e05379c7.png">

- (Helm) Include this parameter in your Helm command 


  ```yaml
  newrelic-prometheus-agent.config.kubernetes.integrations_filter.enabled=false
  ```

The scraping configuration can be fully customized to your needs, see the [set up New Relic's Prometheus agent](/docs/integrations/prometheus-integrations/install-configure-prometheus-agent/setup-prometheus-agent) documentation.


## Install the Prometheus agent dashboard [#io-dashboard]

Regardless of whether you installed the Kubernetes integration or only the Prometheus agent, we also give you a curated dashboard for self-metrics with performance and health information, and also metrics volume sent.

Thanks to this dashboard you will get meaningful insights about your Prometheus metrics and your Prometheus Agent like:

* Samples sent by Source
* Unique metrics by Source 
* Timeseries by Source
* Timeseries by Metric (Cardinality)
* Memoroy and CPU consumption
* Targets Failed to scrape
* Total Instances by cluster

1. Install the [dashboard for the Prometheus agent](https://newrelic.com/instant-observability/prometheus-agent) in your New Relic account.

<img style="border: 1px solid black"
  title="Quickstart dashboard for the Prometheus agent"
  alt="Quickstart dashboard for the Prometheus agent"
  src={infrastructurePrometheusIoDashboard}
/>

<figcaption>
  Install the quickstart containing the [dashboard for the Prometheus agent](https://newrelic.com/instant-observability/prometheus-agent).
</figcaption>

## Configure it in Kubernetes [#kubernetes-config]

To configure the agent when using Helm, you should set up your `values.yaml` in one of these two ways:

<Callout variant="tip">
  You need to add your New Relic license key in the `values.yaml` file. To learn more about the license key and how to find it, read about [our main API keys](/docs/apis/intro-apis/new-relic-api-keys/#overview-keys).
</Callout>

<CollapserGroup>
  <Collapser
    id="nri-bundle"
    title="Installed using our Helm bundle"
  >
    ```yaml
    global:
      licenseKey: _YOUR_NEW_RELIC_LICENSE_KEY_
      cluster: _K8S_CLUSTER_NAME_

    newrelic-prometheus-agent:
      enabled: true
      config:
        # YOUR CONFIGURATION GOES HERE. An example:
        static_targets:
          jobs:
            - job_name: self-metrics
              targets:
                - "managed_exporter.your-company.tld:5432"
            - job_name: self-metrics
              targets:
                - "localhost:9090"
              extra_metric_relabel_config:
                - source_labels: [__name__]
                  action: keep
                  regex: "\
                    prometheus_agent_active_series|\
                    prometheus_target_interval_length_seconds|\
                    prometheus_target_scrape_pool_targets|\
                    prometheus_remote_storage_samples_pending|\
                    prometheus_remote_storage_samples_in_total|\
                    prometheus_remote_storage_samples_retried_total|\
                    prometheus_agent_corruptions_total|\
                    prometheus_remote_storage_shards|\
                    prometheus_sd_kubernetes_events_total|\
                    prometheus_agent_checkpoint_creations_failed_total|\
                    prometheus_agent_checkpoint_deletions_failed_total|\
                    prometheus_remote_storage_samples_dropped_total|\
                    prometheus_remote_storage_samples_failed_total|\
                    prometheus_sd_kubernetes_http_request_total|\
                    prometheus_agent_truncate_duration_seconds_sum|\
                    prometheus_build_info|\
                    process_resident_memory_bytes|\
                    process_virtual_memory_bytes|\
                    process_cpu_seconds_total"
    ```
  </Collapser>

  <Collapser
    id="standalone-helm-release"
    title="Standalone Helm release"
  >
    This option is only recommended if you're an advanced user.

    ```yaml
    licenseKey: _YOUR_NEW_RELIC_LICENSE_KEY_
    cluster: _K8S_CLUSTER_NAME_

    config:
      # YOUR CONFIGURATION GOES HERE. An example:
      static_targets:
        jobs:
          - job_name: self-metrics
            targets:
              - "managed_exporter.your-company.tld:5432"
          - job_name: self-metrics
            targets:
              - "localhost:9090"
            extra_metric_relabel_config:
              - source_labels: [__name__]
                action: keep
                regex: "\
                  prometheus_agent_active_series|\
                  prometheus_target_interval_length_seconds|\
                  prometheus_target_scrape_pool_targets|\
                  prometheus_remote_storage_samples_pending|\
                  prometheus_remote_storage_samples_in_total|\
                  prometheus_remote_storage_samples_retried_total|\
                  prometheus_agent_corruptions_total|\
                  prometheus_remote_storage_shards|\
                  prometheus_sd_kubernetes_events_total|\
                  prometheus_agent_checkpoint_creations_failed_total|\
                  prometheus_agent_checkpoint_deletions_failed_total|\
                  prometheus_remote_storage_samples_dropped_total|\
                  prometheus_remote_storage_samples_failed_total|\
                  prometheus_sd_kubernetes_http_request_total|\
                  prometheus_agent_truncate_duration_seconds_sum|\
                  prometheus_build_info|\
                  process_resident_memory_bytes|\
                  process_virtual_memory_bytes|\
                  process_cpu_seconds_total"
    ```
  </Collapser>
</CollapserGroup>

